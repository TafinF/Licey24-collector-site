<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ - {{ class_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='appearance.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <a href="{{ url_for('appearance') }}" class="back-button">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –∫–ª–∞—Å—Å–∞</a>
                <div class="class-title">{{ class_name.replace('-', ' ') }} –∫–ª–∞—Å—Å</div>
                {% if selected_employee %}
                <div class="teacher-info">
                    {{ selected_employee.lastName }} {{ selected_employee.firstName }}
                </div>
                {% endif %}
            </div>
            
            <div class="instructions">
                <div class="instructions-header" onclick="toggleInstructions()">
                    <span>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é</span>
                    <span id="instructionsIcon">‚ñº</span>
                </div>
                <div class="instructions-content" id="instructionsContent">
                    <ul>
                        <li>–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —É—á–µ–Ω–∏–∫–∞, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∏—è</li>
                        <li>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –≤ –ø–æ—è–≤–∏–≤—à–µ–º—Å—è –º–µ–Ω—é</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞</li>
                        <li>–ó–Ω–∞—á–∫–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è —Å–ø—Ä–∞–≤–∞ –æ—Ç –∏–º–µ–Ω–∏ —É—á–µ–Ω–∏–∫–∞</li>
                        <li>–ù–∞–∂–º–∏—Ç–µ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö</li>
                    </ul>
                    <div style="margin-top: 10px; font-weight: 600;">–ó–Ω–∞—á–∫–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π:</div>
                    <ul>
                        <li>üÜî - –ù–µ—Ç –∑–Ω–∞—á–∫–∞</li>
                        <li>üëï - –í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –Ω–µ –ø–æ —É—Å—Ç–∞–≤—É</li>
                        <li>üíá - –í–æ–ª–æ—Å—ã</li>
                        <li>üèÉ - –ù–µ—Ç —Å–ø–æ—Ä—Ç —Ñ–æ—Ä–º—ã</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="student-list" id="studentList">
            {% for student in students %}
            <div class="student-item" onclick="openModal('{{ student }}')">
                <div class="student-name">{{ student }}</div>
                <div class="status" id="status-{{ loop.index0 }}">
                    <span class="no-violations">‚úÖ</span>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="submit-section">
            <button type="button" class="submit-button" onclick="submitData()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π -->
    <div class="violation-modal" id="violationModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –¥–ª—è —É—á–µ–Ω–∏–∫–∞</h3>
            <div class="violation-options">
                <label class="violation-option">
                    <input type="checkbox" id="noBadge" name="violations" value="–ù–µ—Ç –∑–Ω–∞—á–∫–∞">
                    <span class="checkmark"></span>
                    <span class="violation-label">
                        <span class="violation-emoji">üÜî</span>
                        –ù–µ—Ç –∑–Ω–∞—á–∫–∞
                    </span>
                </label>
                <label class="violation-option">
                    <input type="checkbox" id="uniformViolation" name="violations" value="–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –Ω–µ –ø–æ —É—Å—Ç–∞–≤—É">
                    <span class="checkmark"></span>
                    <span class="violation-label">
                        <span class="violation-emoji">üëï</span>
                        –í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –Ω–µ –ø–æ —É—Å—Ç–∞–≤—É
                    </span>
                </label>
                <label class="violation-option">
                    <input type="checkbox" id="hairViolation" name="violations" value="–í–æ–ª–æ—Å—ã">
                    <span class="checkmark"></span>
                    <span class="violation-label">
                        <span class="violation-emoji">üíá</span>
                        –í–æ–ª–æ—Å—ã
                    </span>
                </label>
                <label class="violation-option">
                    <input type="checkbox" id="noSportswear" name="violations" value="–ù–µ—Ç —Å–ø–æ—Ä—Ç —Ñ–æ—Ä–º—ã">
                    <span class="checkmark"></span>
                    <span class="violation-label">
                        <span class="violation-emoji">üèÉ</span>
                        –ù–µ—Ç —Å–ø–æ—Ä—Ç —Ñ–æ—Ä–º—ã
                    </span>
                </label>
            </div>
            <div class="modal-buttons">
                <button type="button" class="cancel-button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="save-button" onclick="saveViolations()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –•—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –æ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö –ª–æ–∫–∞–ª—å–Ω–æ
        const violationsData = {};
        let currentStudent = null;
        const students = {{ students|tojson }};
        const class_name = "{{ class_name }}";

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
        students.forEach(student => {
            violationsData[student] = [];
        });

        function openModal(studentName) {
            currentStudent = studentName;
            document.getElementById('modalTitle').textContent = `–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –¥–ª—è ${studentName}`;
            
            // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
            document.querySelectorAll('.violation-options input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞
            violationsData[studentName].forEach(violation => {
                const checkbox = document.querySelector(`input[value="${violation}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            
            document.getElementById('violationModal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('violationModal').style.display = 'none';
            currentStudent = null;
        }
        
        function saveViolations() {
            if (currentStudent === null) return;
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
            const selectedViolations = [];
            document.querySelectorAll('.violation-options input[type="checkbox"]:checked').forEach(checkbox => {
                selectedViolations.push(checkbox.value);
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            violationsData[currentStudent] = selectedViolations;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            updateStudentDisplay(currentStudent);
            
            closeModal();
        }
        
        function updateStudentDisplay(studentName) {
            const studentIndex = students.indexOf(studentName);
            const statusElement = document.getElementById(`status-${studentIndex}`);
            const violations = violationsData[studentName];
            
            if (violations.length === 0) {
                statusElement.innerHTML = '<span class="no-violations">‚úÖ</span>';
            } else {
                let iconsHtml = '';
                violations.forEach(violation => {
                    let emoji = '';
                    if (violation === '–ù–µ—Ç –∑–Ω–∞—á–∫–∞') emoji = 'üÜî';
                    else if (violation === '–í–Ω–µ—à–Ω–∏–π –≤–∏–¥ –Ω–µ –ø–æ —É—Å—Ç–∞–≤—É') emoji = 'üëï';
                    else if (violation === '–í–æ–ª–æ—Å—ã') emoji = 'üíá';
                    else if (violation === '–ù–µ—Ç —Å–ø–æ—Ä—Ç —Ñ–æ—Ä–º—ã') emoji = 'üèÉ';
                    
                    iconsHtml += `<span class="violation-icon" title="${violation}">${emoji}</span>`;
                });
                
                statusElement.innerHTML = iconsHtml + `<span class="violation-count">${violations.length}</span>`;
            }
        }
        
        async function submitData() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const hasViolations = Object.values(violationsData).some(violations => violations.length > 0);
            
            if (!hasViolations) {
                if (!confirm('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—É—Å—Ç–æ–π –æ—Ç—á–µ—Ç?')) {
                    return;
                }
            }
            
            try {
                const response = await fetch('/submit-appearance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        class_name: class_name,
                        violations: violationsData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—Ö–∞
                    window.location.href = `/appearance-submission-success?class_name=${encodeURIComponent(class_name)}&timestamp=${encodeURIComponent(result.timestamp)}`;
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            }
        }
        
        function toggleInstructions() {
            const content = document.getElementById('instructionsContent');
            const icon = document.getElementById('instructionsIcon');
            
            if (content.style.display === 'block') {
                content.style.display = 'none';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'block';
                icon.textContent = '‚ñ≤';
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById('violationModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–π –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        });
    </script>
</body>
</html>